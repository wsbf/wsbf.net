"use strict";var scheduleModule=angular.module("wizbif.schedule",["ngFileUpload","ui.bootstrap","wizbif.alert","wizbif.database"]);scheduleModule.controller("ScheduleCtrl",["$scope","$q","$uibModal","$rootScope","db","alert",function(e,t,n,r,o,s){e.days=o.getDefs("days"),e.show_times=o.getDefs("show_times"),e.schedule=[];var u=function(){var n=e.days.map(function(e){return o.Schedule.get(e.dayID)});t.all(n).then(function(t){e.schedule=e.show_times.map(function(){return new Array(e.days.length)}),t.reduce(function(e,t){return e.concat(t)},[]).forEach(function(t){e.schedule[t.show_timeID][t.dayID]=t})})};e.removeSchedule=function(){confirm("Are you sure you want to remove the entire show schedule?")&&confirm("So you're absolutely sure? I don't want to have to fix everything if you mess up.")&&"STATHGAR"===prompt("Type 'STATHGAR' to show me that you're for real.")&&o.Schedule.clear().then(function(){u(),s.success("Schedule successfully cleared.")},function(e){s.error(e.data||e.statusText)})},e.getShow=function(e){n.open({templateUrl:"views/schedule_show.html",controller:"ScheduleShowCtrl",scope:angular.extend(r.$new(),{scheduleID:e})})},e.editShow=function(e,t,o){n.open({templateUrl:"views/schedule_admin_edit.html",controller:"ScheduleEditCtrl",scope:angular.extend(r.$new(),{scheduleID:e,dayID:t,show_timeID:o})}).result.then(u)},e.removeShow=function(e){confirm("Remove show "+e+" from the schedule?")&&o.Schedule.removeShow(e).then(function(){u(),s.success("Show successfully removed.")},function(e){s.error(e.data||e.statusText)})},t.all([e.days.$promise,e.show_times.$promise]).then(u)}]),scheduleModule.controller("ScheduleShowCtrl",["$scope","db",function(e,t){e.days=t.getDefs("days"),e.general_genres=t.getDefs("general_genres"),e.show_times=t.getDefs("show_times"),e.show_types=t.getDefs("show_types"),e.show=t.Schedule.getShow(e.scheduleID)}]),scheduleModule.controller("ScheduleEditCtrl",["$scope","db","alert",function(e,t,n){e.days=t.getDefs("days"),e.show_times=t.getDefs("show_times"),e.show_types=t.getDefs("show_types"),e.searchUsers=function(e){return t.Users.search(e).then(function(e){return e.forEach(function(e){e.name=e.preferred_name===e.first_name+" "+e.last_name?e.preferred_name:e.first_name+" "+e.last_name+" ("+e.preferred_name+")"}),e})},e.addHost=function(){e.show.hosts.push(e.newHost),e.newHost=null},e.save=function(r){t.Schedule.saveShow(r).then(function(){n.success("Show successfully saved."),e.$close()},function(e){n.error(e.data||e.statusText)})},e.show_times.$promise.then(function(){e.scheduleID?e.show=t.Schedule.getShow(e.scheduleID):e.show={dayID:e.dayID,show_timeID:e.show_timeID,hosts:[]}})}]),scheduleModule.controller("ScheduleInternsCtrl",["$scope","$q","alert","db","Upload",function(e,t,n,r,o){e.days=r.getDefs("days"),e.show_times=r.getDefs("show_times"),e.schedule=null,e.interns={},e.prevInternTimes={},e.stats={};var s=function(){t.all(e.days.map(function(e){return r.Schedule.get(e.dayID)})).then(function(t){e.schedule=e.show_times.map(function(e){return t.map(function(t){return _.find(t,{start_time:e.show_time})})})})},u=function(e){return t(function(t,r){var o=new FileReader;o.onload=function(e){var n=e.target.result,r=n.split("\n").filter(function(e){return e.length>0}).reduce(function(e,t){var n=t.split(","),r=n[0],o=n.slice(1).filter(function(e){return e.length>3}).map(function(e){var t=e.split(" ");return{dayID:Number.parseInt(t[0]),show_timeID:Number.parseInt(t[1])}});return e[r]=o,e},{});t(r)},o.onerror=function(){n.error("Could not load file."),r()},o.readAsText(e)})};e.loadInternsCSV=function(t){t&&u(t).then(function(t){e.interns=t})},e.loadPrevInternTimesCSV=function(t){t&&u(t).then(function(t){e.prevInternTimes=t})},e.scheduleInterns=function(t,r,o){t.reduce(function(e,t){return e.concat(t)},[]).filter(angular.identity).forEach(function(e){e.interns=[]}),Object.keys(r).forEach(function(e){o[e]=o[e]||[]}),Object.keys(r).forEach(function(e){var n=o[e];r[e]=r[e].filter(function(e){return t[e.show_timeID][e.dayID]}).filter(function(e){return!_.find(n,e)})}),Object.keys(r).forEach(function(e){if(0===r[e].length)return void n.error("Unable to schedule "+e);for(var o=_.shuffle(r[e]),s=!1,u=0;u<o.length&&!s;u++){var c=o[u],i=t[c.show_timeID][c.dayID];0===i.interns.length&&(i.interns.push(e),s=!0)}for(u=0;u<o.length&&!s;u++){var c=o[u],i=t[c.show_timeID][c.dayID];i.interns.length<2&&(i.interns.push(e),s=!0)}s||n.error("Unable to schedule "+e)});var s=t.reduce(function(e,t){return e.concat(t)},[]).filter(angular.identity).reduce(function(e,t){return 0===t.interns.length?e.empty++:1===t.interns.length?e.single++:2===t.interns.length&&e["double"]++,e.total++,e},{empty:0,single:0,"double":0,total:0});angular.extend(e.stats,s),e.scheduleUrl&&window.URL.revokeObjectURL(e.scheduleUrl);var u=t.map(function(e){return e.map(function(e){return e?e.interns.join(" "):""}).join(",")}).join("\n"),c=new Blob([u],{type:"text/csv"});e.scheduleUrl=window.URL.createObjectURL(c),e.prevInternTimesUrl&&window.URL.revokeObjectURL(e.scheduleUrl);var o=angular.copy(e.prevInternTimes);t.forEach(function(e,t){e.forEach(function(e,n){e&&e.interns.forEach(function(e){o[e].push({dayID:n,show_timeID:t})})})});var i=Object.keys(o).map(function(e){var t=o[e].map(function(e){return e.dayID+" "+e.show_timeID});return[e].concat(t).join(",")}).join("\n"),l=new Blob([i],{type:"text/csv"});e.prevInternTimesUrl=window.URL.createObjectURL(l)},t.all([e.days.$promise,e.show_times.$promise]).then(s)}]);